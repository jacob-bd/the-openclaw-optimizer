name: OpenClaw Version Monitor

on:
  schedule:
    - cron: '0 9 * * *'       # Daily at 9am UTC
  workflow_dispatch:            # Manual trigger from Actions UI

concurrency:
  group: version-check
  cancel-in-progress: true

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Read skill version from SKILL.md
        id: skill
        run: |
          VERSION=$(python3 -c "
          with open('SKILL.md') as f:
              for line in f:
                  if line.startswith('version:'):
                      print(line.split(':', 1)[1].strip())
                      break
          ")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Fetch latest OpenClaw release
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(gh api repos/openclaw/openclaw/releases/latest --jq '.tag_name // ""' 2>/dev/null || echo "")
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Fetch changelog
        id: changelog
        if: steps.latest.outputs.version != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LATEST_VER: ${{ steps.latest.outputs.version }}
        run: |
          BODY=$(gh api "repos/openclaw/openclaw/releases/tags/v${LATEST_VER}" \
            --jq '.body // "No changelog available."' 2>/dev/null \
            || echo "No changelog available.")
          BODY="${BODY:0:2000}"
          # Multiline output with random delimiter
          DELIM=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          {
            echo "body<<$DELIM"
            echo "$BODY"
            echo "$DELIM"
          } >> "$GITHUB_OUTPUT"

      - name: Compare versions
        id: compare
        env:
          SKILL_VER: ${{ steps.skill.outputs.version }}
          LATEST_VER: ${{ steps.latest.outputs.version }}
        run: |
          echo "Skill:   $SKILL_VER"
          echo "Latest:  $LATEST_VER"
          if [ -n "$LATEST_VER" ] && [ "$SKILL_VER" != "$LATEST_VER" ]; then
            echo "drift=true" >> "$GITHUB_OUTPUT"
          else
            echo "drift=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Close resolved drift issues
        if: steps.compare.outputs.drift == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'version-drift',
            });
            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Resolved — skill version now matches OpenClaw latest.',
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed',
              });
              console.log(`Closed drift issue #${issue.number}`);
            }

      - name: Check for existing open drift issue
        id: existing
        if: steps.compare.outputs.drift == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'version-drift',
            });
            return issues.length > 0;
          result-encoding: string

      - name: Open version drift issue
        if: steps.compare.outputs.drift == 'true' && steps.existing.outputs.result != 'true'
        uses: actions/github-script@v7
        env:
          SKILL_VER: ${{ steps.skill.outputs.version }}
          LATEST_VER: ${{ steps.latest.outputs.version }}
          CHANGELOG: ${{ steps.changelog.outputs.body }}
        with:
          script: |
            const skillVer = process.env.SKILL_VER;
            const latestVer = process.env.LATEST_VER;
            const changelog = (process.env.CHANGELOG || 'No changelog available.').trim();

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `OpenClaw v${latestVer} released — skill at v${skillVer}`,
              body: [
                '## Version Drift Detected',
                '',
                '| | Version |',
                '|---|---|',
                `| Skill | \`${skillVer}\` |`,
                `| OpenClaw | \`${latestVer}\` |`,
                '',
                '## Update Instructions',
                '',
                '```bash',
                'bash ~/.claude/skills/openclaw-optimizer/scripts/update-skill.sh',
                '```',
                '',
                'Or invoke the `openclaw-optimizer` skill in Claude Code — the runtime check will detect drift automatically.',
                '',
                '## Changelog',
                '',
                '```',
                changelog,
                '```',
              ].join('\n'),
              labels: ['version-drift', 'auto-update'],
            });
            console.log(`Opened drift issue: v${skillVer} → v${latestVer}`);

      - name: Summary
        if: always()
        env:
          SKILL_VER: ${{ steps.skill.outputs.version }}
          LATEST_VER: ${{ steps.latest.outputs.version }}
          DRIFT: ${{ steps.compare.outputs.drift }}
        run: |
          {
            echo "### Version Check"
            echo "| | Version |"
            echo "|---|---|"
            echo "| Skill | \`$SKILL_VER\` |"
            echo "| OpenClaw | \`${LATEST_VER:-unknown}\` |"
            echo "| Drift | $DRIFT |"
          } >> "$GITHUB_STEP_SUMMARY"
